<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AWB Köln – Abfuhrtermine Frohnhof</title>
<style>
  :root{--bg:#f9fafb;--fg:#111827;--muted:#6b7280;--border:#e5e7eb}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:1rem;background:var(--bg);color:var(--fg)}
  h2{margin:.2rem 0 1rem 0;font-size:1.1rem}
  .row{display:block;margin:.5rem 0;padding:.65rem;border:1px solid var(--border);border-radius:10px;background:#fff}
  .row.heute{border:2px solid #111827}
  .date{font-weight:600;margin-bottom:.25rem}
  .muted{color:var(--muted)}
  .small{font-size:.75rem;color:var(--muted);margin-top:.5rem}
  .error{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;padding:.6rem;border-radius:8px}

  .iconsline{display:flex;flex-wrap:wrap;gap:14px;align-items:flex-start}
  .item{display:inline-flex;gap:8px;align-items:center}
  .bin{width:24px;height:24px;display:inline-block;vertical-align:middle;flex:0 0 auto}
  .stack{display:flex;flex-direction:column;line-height:1.15}
  .label{font-weight:600}
  .sub{font-size:.8rem;color:var(--muted)}
  .blink svg{animation:blink 1s infinite alternate}
  @keyframes blink{0%{opacity:1}100%{opacity:.35}}
</style>
</head>
<body>
<h2>Abfuhrtermine Frohnhof (AWB Köln)</h2>
<div id="status" class="small">Lade Termine …</div>
<div id="list"></div>
<div class="small">Quelle: lokale Kopie <code>awb.ics</code> • Stand: <span id="stand">–</span></div>

<script>
const ICS_PATH = "./awb.ics"; // gleiche Origin

// Anzeigenamen (oben fett) und Inhalte (klein darunter)
const LABELS={
  Restmüll:{top:"Schwarze Tonne", sub:"Restmüll"},
  Biotonne:{top:"Braune Tonne", sub:"Biotonne"},
  Wertstofftonne:{top:"Gelbe Tonne", sub:"Wertstofftonne"},
  Papiertonne:{top:"Blaue Tonne", sub:"Papier"},
  Weihnachtsbaum:{top:"Weihnachtsbaum", sub:"Sonderabfuhr"},
  Sperrmüll:{top:"Sperrmüll", sub:"Sonderabfuhr"}
};
const COLORS={
  Restmüll:"#111827", Biotonne:"#92400e", Wertstofftonne:"#ca8a04",
  Papiertonne:"#1e40af", Weihnachtsbaum:"#065f46", Sperrmüll:"#7c3aed"
};
const ORDER=["Restmüll","Biotonne","Wertstofftonne","Papiertonne","Sperrmüll","Weihnachtsbaum"];

function binSVG(color){
  return `
    <svg width="24" height="24" viewBox="0 0 28 28" aria-hidden="true">
      <rect x="7" y="9" width="14" height="14" rx="3" fill="${color}" />
      <rect x="6" y="7" width="16" height="3" rx="1.5" fill="${color}" />
      <rect x="10.5" y="5" width="7" height="2" rx="1" fill="${color}" />
    </svg>`;
}

function setStand(){
  document.getElementById("stand").textContent=new Date().toLocaleString("de-DE",{dateStyle:"short",timeStyle:"short"});
}

function unfoldICS(text){
  const lines=text.replace(/\r/g,"").split("\n"); const out=[];
  for(const l of lines){ if(l.startsWith(" ")||l.startsWith("\t")) out[out.length-1]+=l.slice(1); else out.push(l); }
  return out;
}
function parseEvents(text){
  const lines=unfoldICS(text); const events=[]; let cur=null;
  for(const L0 of lines){
    const L=L0.trim();
    if(L==="BEGIN:VEVENT"){cur={};continue;}
    if(L==="END:VEVENT"){ if(cur&&cur.dt&&cur.summary) events.push(cur); cur=null; continue;}
    if(!cur) continue;
    if(L.startsWith("DTSTART")){
      const m=L.match(/DTSTART(?:;[^:]+)?:([0-9]{8}(?:T[0-9]{6}Z?)?)/i);
      if(m){ const v=m[1], y=v.slice(0,4), mo=v.slice(4,6), d=v.slice(6,8);
        cur.dt=new Date(`${y}-${mo}-${d}T06:00:00`);
      }
    } else if(L.startsWith("SUMMARY")){
      cur.summary=L.split(":").slice(1).join(":").trim();
    }
  }
  events.sort((a,b)=>a.dt-b.dt);
  return events;
}

// Mehrfach-Erkennung pro SUMMARY (inkl. Farbsynonyme)
function detectTypes(summary){
  const s=summary.toLowerCase();
  const found=new Set();

  // Restmüll (grau/schwarz/hausmüll/rest-)
  if (s.match(/\brestm(ü|u)ll\b/) || s.includes("restabfall") || s.includes("hausm") ||
      s.includes("grau") || s.includes("schwarz") || s.includes("schwarze tonne") || s.includes("rest-"))
    found.add("Restmüll");

  // Biotonne (braun/grünabfall)
  if (s.includes("bioton") || s.includes("bioabfall") || s.includes("grünabfall") || s.includes("gruenabfall") ||
      s.includes(" bio") || s.includes("(braun") || s.includes(" braun"))
    found.add("Biotonne");

  // Wertstoff (gelb/LVP)
  if (s.includes("wertstoff") || s.includes("gelbe tonne") || s.includes("gelben sack") || s.includes(" lvp") || s.includes(" gelb"))
    found.add("Wertstofftonne");

  // Papier (blau/altpapier)
  if (s.includes("papier") || s.includes("altpapier") || s.includes("blaue tonne") || s.includes(" blau"))
    found.add("Papiertonne");

  // Sonderabfuhren
  if (s.includes("weihnachtsbaum")) found.add("Weihnachtsbaum");
  if (s.includes("sperrm")) found.add("Sperrmüll");

  if (found.size===0) found.add("Restmüll");
  return Array.from(found);
}

function ymd(d){ return d.toISOString().slice(0,10); }
function fmtDateLong(d){ return d.toLocaleDateString("de-DE",{weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"}); }

async function run(){
  const status=document.getElementById("status");
  const list=document.getElementById("list");
  try{
    const res=await fetch(ICS_PATH+"?t="+Date.now(),{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const txt=await res.text();
    if(!txt || txt.length<200){ throw new Error("Datei leer/ungültig"); }

    const all=parseEvents(txt);
    const today=new Date(new Date().toDateString());
    const tomorrow=new Date(today); tomorrow.setDate(today.getDate()+1);

    // NUR die nächsten 3 Kalendertage (inkl. heute)
    const groups = new Map();
    for(const ev of all){
      if(ev.dt < today) continue;
      const k=ymd(ev.dt);
      const types = detectTypes(ev.summary);
      if(!groups.has(k)) groups.set(k, new Set());
      types.forEach(t => groups.get(k).add(t));
    }
    const nextKeys = Array.from(groups.keys()).sort().slice(0,3);

    if(nextKeys.length===0){
      list.innerHTML='<div class="error">Keine kommenden Termine in den nächsten 3 Tagen.</div>';
      status.textContent="Hinweis"; setStand(); return;
    }

    list.innerHTML = nextKeys.map(k=>{
      const d=new Date(k);
      const isToday=d.toDateString()===today.toDateString();
      const isTomorrow=d.toDateString()===tomorrow.toDateString();
      const types = ORDER.filter(t => groups.get(k).has(t));

      const parts = types.map(t=>{
        const svg = binSVG(COLORS[t]||"#111827");
        const blinkClass = (isToday || isTomorrow) ? " blink" : "";
        const lab = LABELS[t] || {top:t, sub:""};
        return `
          <span class="item">
            <span class="bin${blinkClass}">${svg}</span>
            <span class="stack">
              <span class="label">${lab.top}</span>
              <span class="sub">${lab.sub}</span>
            </span>
          </span>`;
      });

      const joined = parts.join(' <span class="muted">/</span> ');

      return `
        <div class="row ${isToday?'heute':''}">
          <div class="date">${fmtDateLong(d)}${isTomorrow?' (morgen)':''}${isToday?' (heute)':''}</div>
          <div class="iconsline">${joined}</div>
        </div>`;
    }).join("");

    status.textContent="aktuell"; setStand();
  }catch(e){
    document.getElementById("list").innerHTML='<div class="error">Fehler: '+(e.message||e)+'</div>';
    status.textContent="Fehler"; setStand();
  }
}

run();
</script>
</body>
</html>
